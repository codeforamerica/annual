<%= partials.header %>
<% requested = _.findWhere(data['categories'], { 'unique-id' : requested }); %>

<% if (requested['color']) { %>
  <style>
    ul.story__body__content__links li a:before {
      background-color: <%= requested['color'] %>;
    }
    .story__body__header {
      background-color: <%= requested['color'] %>;
    }
  </style>
<% } %>

<header id="js-header">
  <div class="logo">
    <a href="#">Code for America  &nbsp;|&nbsp; 2014 Annual Report</a>
  </div>
  <nav class="nav">
    <ul>
      <li class="currently">Currently Reading:</li>
      <% if (data.opener) { %>
        <% opener = data.opener[0] %>
        <li><a href="/"><%= opener['category'] %></a></li>
      <% } %>
      <% _.each(data['categories'], function(category){ %>
        <li class="
        <% if (category['unique-id'] == requested['unique-id']) { %>
        active
        <% } %>
        "><a href="/category/<%= category['unique-id'] %>"><%= category['category'] %></a></li>
      <% }); %>
      <li class="expand"></li>
    </ul>
  </nav>
</header>

<div id="js-main">
  <section class="stories" id="{{ page.unique-id }}">

    <% _.each(data['categories'], function(category){ %>
      <% if (category['unique-id'] == requested['unique-id']) { %>
        <div class="intro" style="
          <% if (category['color']) { %>
            background-color: <%= category['color'] %>;
          <% } %>
        ">

          <div class="container">

            <div class="intro__content">
              <p class="intro__content__overline">
                <%= category['category'] %>
              </p>
              <h1><%= category['headline'] %></h1>
              <p><%= category['description'] %></p> 
            </div>

          </div><!-- end .container -->
        </div><!-- end .intro -->
      <% } %>
    <% });%>
    
    <div class="container">
      <div class="financials">
        <div class="financials__header">
          <h1>Total 2014 Expenses:</h1>
          <p class="financials__header__total"><%= data['financials'][3]['amount'] %></p>
        </div>

        <div class="financials__breakdown">
          <h1>Breakdown by Program:</h1>
          <div class="financials__breakdown__chart">
            <canvas id="financials__chart" width="500px" height="500px"></canvas>
          </div>
          <div class="financials__breakdown__key">
            <ul>
              <li id="program">
                <p><span><%= data['financials'][0]['percentage'] %>%</span> Program: $8,203,623</p>
              </li>
              <li id="general-administration">
                <p><span><%= data['financials'][2]['percentage'] %>%</span> General Administration: $892,541</p>
              </li>
              <li id="fundraising">
                <p><span><%= data['financials'][1]['percentage'] %>%</span> Fundraising: $520,492</p>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div><!-- end .container -->
  </section>
</div>

<%
var currentIndex,
    nextIndex,
    indexLength;

var currentIndex = _.indexOf(data['categories'], requested);
var nextIndex = currentIndex + 1;
indexLength = data['categories'].length - 1;

if (nextIndex <= indexLength) {
  nextIndex = nextIndex;
} else {
  nextIndex = false;
}
%>

<% if (_.isNumber(nextIndex)){ %>
  <% var nextCategory = data['categories'][nextIndex] %>
  <div class="next">
    <a class="next__link" href="/category/<%= nextCategory['unique-id'] %>" style="
    <% if (nextCategory['color']) { %>
      background-color: <%= nextCategory['color'] %>;
    <% } %>
    ">
      <div class="container">
          <div class="next__content">
            <p class="next__content__read">Continue Reading:</p>
            <p class="next__content__overline"><%= nextCategory['category'] %></p>
            <p class="next__content__headline"><span><%= nextCategory['headline'] %></span></p>
          </div><!-- end .next__cpntent -->
      </div><!-- end .container -->
    </a>
  </div><!-- end .next -->
<% } %>

<script src="/scripts/vendor/Chart.js"></script>
<%= partials.charts %>
<script>
  var financialData = [
      // Program
      {
          value: <%= data['financials'][0]['percentage'] %>,
          color:"#69579C",
          highlight: "#69579C",
          label: "<%= data['financials'][0]['expense-type'] %>: <%= data['financials'][0]['amount'] %>"
      },
      // Fundraising
      {
          value: <%= data['financials'][1]['percentage'] %>,
          color: "#aa1c3a",
          highlight: "#aa1c3a",
          label: "<%= data['financials'][1]['expense-type'] %>: <%= data['financials'][1]['amount'] %>"
      },
      // Gen Admin
      {
          value: <%= data['financials'][2]['percentage'] %>,
          color: "#00a175",
          highlight: "#00a175",
          label: "<%= data['financials'][2]['expense-type'] %>: <%= data['financials'][2]['amount'] %>"
      }
  ]

  // Get the context of the canvas element we want to select
  var ctx = document.getElementById("financials__chart").getContext("2d");
  var myPieChart = new Chart(ctx).Pie(financialData,{
      responsive: true,
      animationEasing: "easeOutQuart"
  });

</script>

<%= partials.footer %>