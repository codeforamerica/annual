var summit = [{
    "geometry": { "type": "Point", "coordinates": [-75.162, 39.947]},
    "properties": { "city": "philadelphia", "year": "2011", "type": "fellowship", "story":"summit" }
  },  {
    "geometry": { "type": "Point", "coordinates": [-71.053, 42.352]},
    "properties": { "city": "boston", "year": "2011", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.326, 47.604]},
    "properties": { "city": "seattle", "year": "2011", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-82.553889, 35.600833]},
    "properties": { "city": "asheville", "year":"2012", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.00, 38.05]},
    "properties": { "city": "lexington", "year":"2012", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-78.78, 35.87]},
    "properties": { "city": "raleigh", "year":"2012", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-117.13, 32.82]},
    "properties": { "city": "San Diego", "year":"2012", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-74.003, 40.701]},
    "properties": { "city": "new york", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.16, 37.48]},
    "properties": { "city": "oakland", "year":"2013", "type": "fellowship", "story":"summit" }
  },{
    "geometry": { "type": "Point", "coordinates": [-90.087, 29.968]},
    "properties": { "city": "neworleans", "year":"2012", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.0306, 36.9724]},
    "properties": { "city": "santacruz", "year":"2012", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-87.655, 41.886]},
    "properties": { "city": "chicago", "year":"2012", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-83.059, 42.360]},
    "properties": { "city": "detroit", "year":"2012", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-157.859, 21.305]},
    "properties": { "city": "honolulu", "year":"2012", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-97.756, 30.276]},
    "properties": { "city": "austin", "year":"2012", "type": "fellowship", "story":"summit"}
  }, {
    "geometry": { "type": "Point", "coordinates": [-150.02, 61.17]},
    "properties": { "city": "anchorage", "year":"2013", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-78.898619, 35.994033]},
    "properties": { "city": "durham", "year":"2012", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-95.35, 29.97]},
    "properties": { "city": "houston", "year":"2013", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-93.47, 44.83]},
    "properties": { "city": "minneapolis", "year":"2013", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-121.50, 38.52]},
    "properties": { "city": "sacramento", "year":"2013", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-111.97, 40.78]},
    "properties": { "city": "salt lake city", "year":"2013", "type": "brigade", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.748291, 38.242495]},
    "properties": { "city": "louisville", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-99.133208, 19.432608]},
    "properties": { "city": "mexico city", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.26, 37.47]},
    "properties": { "city": "san francisco", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.16, 37.48]},
    "properties": { "city": "oakland", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.333, 37.4023]},
    "properties": { "city": "san mateo", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-115.12, 36.10]},
    "properties": { "city": "las vegas", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-94.581299, 39.087436]},
    "properties": { "city": "kansas city mo", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.499, 41.137]},
    "properties": { "city": "summit county", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-86.251990, 41.676355]},
    "properties": { "city": "south bend", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-74.003, 40.701]},
    "properties": { "city": "new york", "year":"2013", "type": "fellowship", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.347749, 37.935758]},
    "properties": { "city": "richmond ca", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-97.330766, 32.755488]},
    "properties": { "city": "fort worth", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-76.612189, 39.290385]},
    "properties": { "city": "baltimore", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-82.800103, 27.965853]},
    "properties": { "city": "Clearwater FL", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.156077, 37.724930]},
    "properties": { "city": "San Leandro  CA", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-117.350594, 33.158093]},
    "properties": { "city": "Carlsbad CA", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-104.821363, 38.833882]},
    "properties": { "city": "Colorado Springs CO", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.143019, 37.441883]},
    "properties": { "city": "Palo Alto  CA", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-97.133068, 33.214841]},
    "properties": { "city": "Denton TX", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-87.687697, 42.045072]},
    "properties": { "city": "Evanston IL", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-106.609991, 35.110703]},
    "properties": { "city": "Albuquerque  NM", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-84.387982, 33.748995]},
    "properties": { "city": "Atlanta  GA", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-86.526386, 39.165325]},
    "properties": { "city": "Bloomington  IN", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-73.756232, 42.652579]},
    "properties": { "city": "Albany NY", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-105.500548, 40.151211]},
    "properties": { "city": "Boulder County CO", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-80.843127, 35.227087]},
    "properties": { "city": "Charlotte  NC", "year":"2013", "type": "peer", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-80.008775, 40.445081]},
    "properties": { "city": "Allegheny County, pa", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-105.087484, 39.802764]},
    "properties": { "city": "Arvada", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.309680, 35.045630]},
    "properties": { "city": "Chattanooga", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.695409, 41.499495]},
    "properties": { "city": "Cleveland", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-104.984718, 39.737567]},
    "properties": { "city": "Denver", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.310765, 37.916133]},
    "properties": { "city": "El Cerrito", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-106.496805, 31.769956]},
    "properties": { "city": "El Paso", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.430201, 45.500136]},
    "properties": { "city": "Gresham", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-116.310009, 33.663357]},
    "properties": { "city": "La Quinta", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-118.195617, 33.768321]},
    "properties": { "city": "Long Beach", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.114130, 37.385218]},
    "properties": { "city": "Los Altos", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-118.243685, 34.052234]},
    "properties": { "city": "Los Angeles", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-89.401230, 43.073052]},
    "properties": { "city": "Madison", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-111.831472, 33.415184]},
    "properties": { "city": "Mesa", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-80.130045, 25.790654]},
    "properties": { "city": "Miami Beach", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-86.783333, 36.166667]},
    "properties": { "city": "Nashville", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-118.144516, 34.147785]},
    "properties": { "city": "Pasadena", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.231635, 37.824371]},
    "properties": { "city": "Piedmont", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-79.995886, 40.440625]},
    "properties": { "city": "Pittsburgh", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-93.061598, 44.996399]},
    "properties": { "city": "Ramsey County", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.121512, 47.673988]},
    "properties": { "city": "Redmond", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-77.436048, 37.540725]},
    "properties": { "city": "Richmond VA", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-98.493628, 29.424122]},
    "properties": { "city": "San Antonio", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-121.719546, 37.293891]},
    "properties": { "city": "Santa Clara County", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-118.491191, 34.019454]},
    "properties": { "city": "Santa Monica", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.099834, 32.083541]},
    "properties": { "city": "Savannah", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-121.425223, 37.739651]},
    "properties": { "city": "Tracy", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-110.926479, 32.221743]},
    "properties": { "city": "Tuscon", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.256637, 38.104086]},
    "properties": { "city": "Vallejo", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-89.817346, 44.383576]},
    "properties": { "city": "Wisconsin Rapids", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-94.769159, 39.098681]},
    "properties": { "city": "Wyandotte County", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-66.105722, 18.466334]},
    "properties": { "city": "San Juan", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.626790, 41.319776]},
    "properties": { "city": "Brecksville", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-121.894955, 37.339386]},
    "properties": { "city": "San Jose", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [138.599959, -34.928621]},
    "properties": { "city": "Adelaide", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.519005, 41.081445]},
    "properties": { "city": "Akron", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.275801, 37.520215]},
    "properties": { "city": "Belmont", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [139.753595, 35.694003]},
    "properties": { "city": "Chiyoda-ku", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-105.221100, 39.755543]},
    "properties": { "city": "Golden", "year":"2013", "story":"summit" }
  }, {
    "geometry": { "type": "Point", "coordinates": [5.799913, 53.201233]},
    "properties": { "city": "Leeuwarden ", "year":"2013", "story":"summit" }
}]

var codeacross = [{
    "geometry": { "type": "Point", "coordinates": [-75.162, 39.947]},
    "properties": { "city": "philadelphia", "story": "codeacross"}
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.326, 47.604]},
    "properties": { "city": "seattle", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.668056, 42.963333]},
    "properties": { "city": "grand rapids", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-78.78, 35.87]},
    "properties": { "city": "raleigh", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-117.13, 32.82]},
    "properties": { "city": "San Diego", "year":"2012", "type": "brigade", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-74.003, 40.701]},
    "properties": { "city": "new york", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.16, 37.48]},
    "properties": { "city": "oakland", "year":"2013", "type": "fellowship", "story":"codeacross" }
}, {
    "geometry": { "type": "Point", "coordinates": [-122.333, 37.4023]},
    "properties": { "city": "san mateo", "year":"2013", "type": "fellowship", "story":"codeacross" }
}, {
    "geometry": { "type": "Point", "coordinates": [-115.12, 36.10]},
    "properties": { "city": "las vegas", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-157.859, 21.305]},
    "properties": { "city": "honolulu", "year":"2012", "type": "fellowship", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-97.756, 30.276]},
    "properties": { "city": "austin", "year":"2012", "type": "fellowship", "story":"codeacross"}
  }, {
    "geometry": { "type": "Point", "coordinates": [-95.35, 29.97]},
    "properties": { "city": "houston", "year":"2013", "type": "brigade", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-93.47, 44.83]},
    "properties": { "city": "minneapolis", "year":"2013", "type": "brigade", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-121.50, 38.52]},
    "properties": { "city": "sacramento", "year":"2013", "type": "brigade", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-77.04, 38.85]},
    "properties": { "city": "washington dc", "year":"2013", "type": "brigade", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-94.581299, 39.087436]},
      "properties": { "city": "kansas city mo", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-85.748291, 38.242495]},
      "properties": { "city": "louisville", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-81.499, 41.137]},
      "properties": { "city": "summit county", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-86.251990, 41.676355]},
      "properties": { "city": "south bend", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.26, 37.47]},
    "properties": { "city": "san francisco", "year":"2013", "type": "fellowship", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-73.15, 44.47]},
    "properties": { "city": "burlington", "year":"2013", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-80.28, 25.8]},
      "properties": { "city": "miami", "year":"2013", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-95.90, 36.20]},
      "properties": { "city": "tulsa", "year":"2013", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-77.04, 38.85]},
      "properties": { "city": "washington dc", "year":"2013", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-76.285873, 36.850769]},
      "properties": { "city": "Norfolk  VA", "year":"2013", "type": "story", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-70.255326, 43.661471]},
      "properties": { "city": "Portland ME", "year":"2013", "type": "story", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-77.046921, 38.804836]},
      "properties": { "city": "Alexandria", "year":"2013", "type": "story", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-81.379236, 28.538335]},
      "properties": { "city": "Orlando", "year":"2013", "type": "story", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-82.010515, 33.473498]},
      "properties": { "city": "Augusta", "year":"2013", "type": "story", "story":"ndoch", "story":"codeacross" }
  },  {
    "geometry": { "type": "Point", "coordinates": [-71.053, 42.352]},
    "properties": { "city": "boston", "year": "2011", "type": "fellowship", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-82.553889, 35.600833]},
    "properties": { "city": "asheville", "year":"2012", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.00, 38.05]},
    "properties": { "city": "lexington", "year":"2012", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-78.78, 35.87]},
    "properties": { "city": "raleigh", "year":"2012", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-83.6365, 32.8398]},
      "properties": { "city": "macon", "year":"2012", "type": "fellowship", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-87.655, 41.886]},
    "properties": { "city": "chicago", "year":"2012", "type": "fellowship", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-83.059, 42.360]},
    "properties": { "city": "detroit", "year":"2012", "type": "fellowship", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-150.02, 61.17]},
    "properties": { "city": "anchorage", "year":"2013", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-111.97, 40.78]},
    "properties": { "city": "salt lake city", "year":"2013", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-104.984718, 39.737567]},
    "properties": { "city": "Denver", "year":"2013", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.099834, 32.083541]},
    "properties": { "city": "Savannah", "year":"2013", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-81.519005, 41.081445]},
    "properties": { "city": "Akron", "year":"2013", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-78.898619, 35.994033]},
    "properties": { "city": "durham", "year":"2012", "type": "brigade", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-87.906474, 43.038902]},
    "properties": { "city": "Milwaukee", "year":"2012", "type": "brigade", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.309680, 35.045630]},
    "properties": { "city": "Chattanooga", "year":"2013", "story":"ndoch", "story":"codeacross" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-75.977985, 36.852926]},
    "properties": { "city": "Virginia Beach", "year":"2013", "story":"ndoch", "story":"codeacross" }
}]

var innovation = [{
    "geometry": { "type": "Point", "coordinates": [-75.162, 39.947]},
    "properties": { "city": "philadelphia", "story": "innovation" }
  },  {
    "geometry": { "type": "Point", "coordinates": [-71.053, 42.352]},
    "properties": { "city": "boston", "year": "2011", "type": "fellowship", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-87.655, 41.886]},
    "properties": { "city": "chicago", "year":"2012", "type": "fellowship", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.26, 37.47]},
    "properties": { "city": "san francisco", "year":"2013", "type": "fellowship", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-86.783333, 36.166667]},
    "properties": { "city": "Nashville", "year":"2013", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-94.581299, 39.087436]},
    "properties": { "city": "kansas city mo", "year":"2013", "type": "fellowship", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-122.156077, 37.724930]},
    "properties": { "city": "San Leandro  CA", "year":"2013", "type": "peer", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-117.396156, 33.953349]},
    "properties": { "city": "Riverside  CA", "year":"2013", "type": "peer", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-121.740517, 38.544907]},
    "properties": { "city": "Davis  CA", "year":"2013", "type": "peer", "story": "innovation" }
  }, {
      "geometry": { "type": "Point", "coordinates": [-77.240515, 39.154743]},
      "properties": { "city": "Montgomery County  MD", "year":"2013", "type": "peer", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-85.748291, 38.242495]},
    "properties": { "city": "louisville", "year":"2013", "type": "fellowship", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-118.243685, 34.052234]},
    "properties": { "city": "Los Angeles", "year":"2013", "story": "innovation" }
  }, {
    "geometry": { "type": "Point", "coordinates": [-97.756, 30.276]},
    "properties": { "city": "austin", "year":"2012", "type": "fellowship", "story": "innovation"}
}]


var fellowshipColor = "e87d2b";
var highlightColor = "69579C";


if (typeof console === "undefined" || typeof console.log === "undefined") {
  console = {log:function(){}};
}

$(function(){
  var readytoshow = false;
  $('<img/>').attr('src', 'img/iphone.jpg').load(function() {
    if(readytoshow)
      $("#loading").fadeOut({duration:1000});
    readytoshow = true;
  });
  setTimeout(function(){
    if(readytoshow)
      $("#loading").fadeOut({duration:1000});
    readytoshow = true;
  }, 1000);
  var usTopology;
  //shows nav when user hovers over the logo
  var height = $(window).height(),
  width = $(window).width();

  var setSize = function(){
    height = $(window).height();
    width = $(window).width();

    $(".quote").css({width:width, "min-height":height});
    $(".story").css({width:width, "min-height":height});
    $(".pagebg").css({width:width, "min-height":height});
    $(".scrollout").css({height:height});
    $(".fellowship").css({height:height});
    $(".map").css({height:height});
    $(".mapscroll").css({height:height});
    scrollEvent.onScroll();

  }

  // var tabContentWidth = $('.yeartitle').css('width')
  // console.log(tabContentWidth);
  // $('.tab-content .tab-pane').css('width', tabContentWidth)

  var scrollEvent = {
    handlers: {top:[], middle:[], bottom:[], inview:[]},
    currentElements: {top:[], middle:[], bottom:[], inview:[]},
    on:function(pos, el, addCb, removeCb){
      var elements = el.toArray();
      var i = 0;
      for(e in elements){
        if(typeof elements[e] !== "object")
          continue;
        scrollEvent.handlers[pos].push({el:elements[e], addCb:addCb, removeCb:removeCb, count:i});
        i++;
      }
    },
    onScroll:function(){
      var pos = $(window).scrollTop();
      var height = $(window).height();

      if(pos < 0)
        return;

      for(e in scrollEvent.handlers.middle){
        var el = scrollEvent.handlers.middle[e].el;
        if(typeof el !== "object")
          continue;

        // console.log(el);
        //middle
        if(($(el).offset().top <= (pos + height/2)) &&
           ($(el).offset().top + $(el).outerHeight()  >= (pos + height/2))){
          scrollEvent.setCurrentElement("middle", scrollEvent.handlers.middle[e]);
       }else{
          scrollEvent.removeCurrentElement("middle", scrollEvent.handlers.middle[e]);
        }
      }

      for(e in scrollEvent.handlers.top){
        var el = scrollEvent.handlers.top[e].el;
        if(typeof el !== "object")
          continue;

        //if the element is at the top of the page
        if(($(el).offset().top <= pos) &&
           ($(el).offset().top + $(el).outerHeight()  >= pos)){
          scrollEvent.setCurrentElement("top", scrollEvent.handlers.top[e]);

        }else{
          scrollEvent.removeCurrentElement("top", scrollEvent.handlers.top[e]);
        }
      }
      for(e in scrollEvent.handlers.bottom){
        var el = scrollEvent.handlers.bottom[e].el;
        if(typeof el !== "object")
          continue;

        //if the element is at the top of the page
        if(($(el).offset().top <= (pos+ height)) &&
           ($(el).offset().top + $(el).outerHeight()  >= (pos +height))){
          scrollEvent.setCurrentElement("bottom", scrollEvent.handlers.bottom[e]);

        }else{
          scrollEvent.removeCurrentElement("bottom", scrollEvent.handlers.bottom[e]);
        }
      }
      for(e in scrollEvent.handlers.inview){
        var el = scrollEvent.handlers.inview[e].el;
        if(typeof el !== "object")
          continue;

        //if the element is at the top of the page
        if(($(el).offset().top + $(el).outerHeight() >= pos) &&
           ($(el).offset().top   <= (pos +height))){
          scrollEvent.setCurrentElement("inview", scrollEvent.handlers.inview[e]);

        }else{
          scrollEvent.removeCurrentElement("inview", scrollEvent.handlers.inview[e]);
        }
      }


    },
    setCurrentElement:function(pos, handler){

      if(scrollEvent.currentElements[pos].indexOf(handler) === -1){
        scrollEvent.currentElements[pos].push(handler);
        handler.addCb(handler.el,handler.count);
      }
    },
    removeCurrentElement:function(pos, handler){

      if(scrollEvent.currentElements[pos].indexOf(handler) >=0 ){
        delete scrollEvent.currentElements[pos][scrollEvent.currentElements[pos].indexOf(handler)];
        handler.removeCb(handler.el,handler.count);
      }
    }
  };

  
  scrollEvent.on("middle", $(".page"), function(el,i){
    $($("div.pagebg")[i]).fadeIn({duration:500});
    if(($(el).attr("class").indexOf("quote") >= 0) || ($(el).attr("class").indexOf("nosidebar") >= 0))
      $("div.sidebartitle").hide();
    else{
      $($("div.sidebartitle")[i]).show();
      $($("div.sidebartitle")[i]).addClass("appear");
    }
  }, function(el, i){
    $($("div.pagebg")[i]).fadeOut({duration:700});
    $($("div.sidebartitle")[i]).removeClass("appear");

  });
  scrollEvent.on("inview", $("iframe[data-src]"), function(el,i){
    if($(el).attr("src") === undefined)
      $(el).attr("src", $(el).attr("data-src"))
  }, function(el, i, pos){
  });


  var showRandomTooltip = function(){

    currentMarker = displayedMarkers[Math.floor(Math.random()*displayedMarkers.length)]

    currentMarker.showTooltip();

    point = map.locationPoint({
      lat: currentMarker.data.geometry.coordinates[1],
      lon: currentMarker.data.geometry.coordinates[0]
    })

    var quarter = map.dimensions.y * (1/ 4);
    point.y -= quarter;
    map.ease.location(map.pointLocation(point)).zoom(map.zoom()).optimal();

  }

  scrollEvent.onScroll();
  $(window).scroll(scrollEvent.onScroll);


  setSize();
  $(window).resize(setSize);

  $('[id^="myCarousel"]').carousel({
    interval: false,
    cycle: true
  });

  $('.captpop').popover({
    placement: 'top',
    trigger: 'hover'
  });

  $('.morefellowspop').popover({
    placement: 'top',
    trigger: 'hover'
  });

  $('.appspop').popover({
    placement: 'top',
    trigger: 'hover',
    html: true
  });

  $('.footnote').popover({
    placement: 'top',
    trigger: 'hover'
  });

  $('.startupspop').popover({
    placement: 'top',
    trigger: 'hover',
    html: true
  });


  // Create map
  var layer = mapbox.layer().id('codeforamerica.h9pfapk3');
  var insetLayer =  mapbox.layer().id('codeforamerica.h9pfapk3');
  var storyLayer

  var map = mapbox.map('map', layer, null, [easey_handlers.DragHandler()]);

  var inset = mapbox.map('mapInset', insetLayer, null, [easey_handlers.DragHandler()]);
  inset.centerzoom({lat: 0, lon: 0 }, 0)

  map.centerzoom({lat: 43.6, lon: -79.4 }, 4)

  var markerLayer = mapbox.markers.layer().url("js/cityLocations.geojson");
  var insetMarkerLayer = mapbox.markers.layer().url("js/cityLocations.geojson");

  var displayedMarkers = [];
  var currentMarker = null;

  // markerLayer.sort(function(a, b) {
  //   return a.geometry.coordinates[0] -
  //     b.geometry.coordinates[0];
  // });

  markerLayer.addCallback("markeradded", function(l, m){
    displayedMarkers.push(m);
     $(m.element).css("opacity", "0");

    setTimeout(function(){
      $(m.element).animate({opacity: 1}, 400)
    }, Math.random() * 300);

  });

  insetMarkerLayer.addCallback("markeradded", function(l, m){
    displayedMarkers.push(m);
     $(m.element).css("opacity", "0");

    setTimeout(function(){
      $(m.element).animate({opacity: 1}, 400)
    }, Math.random() * 300);

  });



  var markerFactory = function() {
    var m = document.getElementById('marker').cloneNode(true);
      m.style.display = 'block';
      return m;
  }

  var insetMarkerFactory = function() {
    var i = document.getElementById('markerInset').cloneNode(true);
      i.style.display = 'block';
      return i;
  }



  var cycleMarker = function(direction){

    var position = displayedMarkers.indexOf(currentMarker);

    if(direction === "next"){

       if(position +1 >= displayedMarkers.length)
        position =0;
      else
        position++;

    }else{
      if(position -1 < 0)
        position =displayedMarkers.length-1;
      else
        position--;
    }
    currentMarker = displayedMarkers[position];
    displayedMarkers[position].showTooltip();

    point = map.locationPoint({
      lat: currentMarker.data.geometry.coordinates[1],
      lon: currentMarker.data.geometry.coordinates[0]
    })

    var quarter = map.dimensions.y * (1/ 8);
    point.y -= quarter;
    map.ease.location(map.pointLocation(point)).zoom(map.zoom()).optimal();

  }


  markerLayer.factory(markerFactory);
  insetMarkerLayer.factory(insetMarkerFactory);

  var years = ["2011", "2012", "2013"]

  $.each(years, function(index, value){
    $('#'+value).on('show.bs.dropdown', function() {
      yearMarkers(value)
    })
  });

  var summitLayer, codeacrossLayer, innovationLayer
  var stories = ["summit", "codeacross", "innovation"]

  map.addLayer(markerLayer);
  inset.addLayer(insetMarkerLayer);



  /*
    Map story events
  */

  $('#mapInnovation').on('show.bs.dropdown', function () {
    // addStories("innovation")
    $svg = $("#marker");
    $("#markerCircle", $svg).attr('style', "stroke-width: 1;stroke: #e87d2b;fill:transparent");
    map.removeLayer(markerLayer);
    map.addLayer(markerLayer)
    markerLayer.filter(function(f) {
       return f.properties['story'] !== 'innovation';
    });

    inset.removeLayer(insetMarkerLayer);
    insetMarkerLayer = mapbox.markers.layer().features(innovation);
    insetMarkerLayer.factory(insetMarkerFactory);
    inset.addLayer(insetMarkerLayer)

    map.removeLayer(summitLayer);
    map.removeLayer(codeacrossLayer);
    innovationLayer = mapbox.markers.layer().features(innovation);
    innovationLayer.named('innovation')
    map.addLayer(innovationLayer);
    innovationLayer.factory(function(f) {
        var highlight = document.getElementById('markerHighlight').cloneNode(true);
        highlight.style.display = 'block';
        return highlight;
    });
    $('#markerHighlight').parent().css("z-index", "100")
  });

  $('#mapInnovation').on('hidden.bs.dropdown', function () {
    inset.removeLayer(insetMarkerLayer);
    yearMarkers("2013")
  })


  $('#codeacross').on('shown.bs.dropdown', function () {
    // addStories("codeacross")
    $svg = $("#marker");
    $("#markerCircle", $svg).attr('style', "stroke-width: 1;stroke: #e87d2b;fill:transparent");
    map.removeLayer(markerLayer);
    map.addLayer(markerLayer)
    markerLayer.filter(function(f) {
       return f.properties['story'] !== 'codeacross';
    });
    inset.removeLayer(insetMarkerLayer);
    insetMarkerLayer = mapbox.markers.layer().features(codeacross);
    insetMarkerLayer.factory(insetMarkerFactory);
    inset.addLayer(insetMarkerLayer)

    map.removeLayer(summitLayer);
    map.removeLayer(innovationLayer);
    codeacrossLayer = mapbox.markers.layer().features(codeacross)
    codeacrossLayer.named('codeacross')

    codeacrossLayer.factory(function(f) {
        var highlight = document.getElementById('markerHighlight').cloneNode(true);
        highlight.style.display = 'block';
        return highlight;
    });
    map.addLayer(codeacrossLayer);
    $('#markerHighlight').parent().css("z-index", "100")
  });

  $('#codeacross').on('hidden.bs.dropdown', function () {
    inset.removeLayer(insetMarkerLayer);
    yearMarkers("2013")
  })


  $('#summit').on('shown.bs.dropdown', function () {
    $svg = $("#marker");
    $("#markerCircle", $svg).attr('style', "stroke-width: 1;stroke: #e87d2b;fill:transparent");
    map.removeLayer(markerLayer);
    map.addLayer(markerLayer)
    markerLayer.filter(function(f) {
        return f.properties['story'] !== 'summit';
    });

    inset.removeLayer(insetMarkerLayer);
    insetMarkerLayer = mapbox.markers.layer().features(summit);
    insetMarkerLayer.factory(insetMarkerFactory);
    inset.addLayer(insetMarkerLayer)


    map.removeLayer(codeacrossLayer)
    map.removeLayer(innovationLayer);
    summitLayer = mapbox.markers.layer().features(summit);
    map.addLayer(summitLayer);

    summitLayer.factory(function(f) {
        var highlight = document.getElementById('markerHighlight').cloneNode(true);
        highlight.style.display = 'block';
        return highlight;
    });
    $('#markerHighlight').parent().css("z-index", "100")
  });

  $('#summit').on('hidden.bs.dropdown', function () {
    inset.removeLayer(insetMarkerLayer);
    yearMarkers("2013")
  })


  function yearMarkers(year) {
    inset.removeLayer(insetMarkerLayer);
    insetMarkerLayer = mapbox.markers.layer().url("js/cityLocations.geojson");
    insetMarkerLayer.factory(insetMarkerFactory);
    inset.addLayer(insetMarkerLayer)
    $svg = $("#marker");
    $svgInsert = $('#markerInset')
    switch (year) {
      case "2011":
        $("#markerCircle", $svg).attr('style', "fill:#6D6E71");
        $("#markerInsetCircle", $svgInsert).attr('style', "fill:#6D6E71");
      break;
      case "2012":
        $("#markerCircle", $svg).attr('style', "fill:#6D6E71");
        $("#markerInsetCircle", $svgInsert).attr('style', "fill:#6D6E71");
      break;
      default:
        $("#markerCircle", $svg).attr('style', "fill:#e87d2b");
        $("#markerInsetCircle", $svgInsert).attr('style', "fill:#e87d2b");
      break;
    }
    map.removeLayer(codeacrossLayer)
    map.removeLayer(summitLayer)
    map.removeLayer(innovationLayer)
    markerLayer.filter(function(f) {
     return f.properties.year <= year;
    });
    insetMarkerLayer.filter(function(e) {
     return e.properties.year <= year;
    });
    return false;
  }

  
function addStories(name) {
  clearTimeout(timer);
  $svg = $("#marker");
  $("#markerCircle", $svg).attr('style', "fill:#999595");
  // map.removeLayer(markerLayer);
  // map.addLayer(markerLayer)
  // markerLayer.filter(function(f) {
  //    return f.properties['story'] !== name;
  // });

  // map.removeLayer(summitLayer);
  // map.removeLayer(innovationLayer);
  // codeacrossLayer = mapbox.markers.layer().features(codeacross);
  // codeacrossLayer.named('codeacross')
  // map.addLayer(codeacrossLayer);
  // $('.simplestyle-marker').parent().css("z-index", "100")


  $.each(stories, function(index, storyName) {
    if(storyName !== name) {
      map.removeLayer(storyName+'Layer');
      storyLayer = mapbox.markers.layer().features(name);
      storyLayer.named(name)
    } else {
      map.addLayer(storyLayer);
      $('.simplestyle-marker').parent().css("z-index", "100")
    }
  });
}

  $($("#map").children()[1]).css("z-index", "1");

  // Attribute map
  map.ui.attribution.add()
    .content('<a href="http://mapbox.com/about/maps">Map by Mapbox</a>');


  // var colors = ["#2f3d4a", "#384857", "#405264", "#50677C", "#839AAF", "#B4C2CF", "#E6EBEF", "#FFFFFF"];
  var colors = ["graph", "graph1", "graph2", "graph3", "graph4", "graph5", "graph6", "graph7"];

  $(".bargraph").each(function(i, el){

    var that = this;

    var total = 0;
    // Count all the money for each data point in the source
    $("."+$(el).attr("data-source")).each(function(i, el){
      // remove commas and dollar signs
      total += parseInt($(el).text().replace(/,/g, "").replace("$", ""));
    });

    // for each group add the hover events
    $(".financialsgroup").each(function(i, el) {
      var group = $(el).attr("data-group");
      $(el).hover(function() {
        $(el).addClass("active");
        $('.group' + group).addClass('active');
      }, function(){
        $(el).removeClass("active");
        $('.group' + group).removeClass('active');
      });
    });

    // for each data point add a section to the graph and hover events
    $("."+$(el).attr("data-source")).each(function(i, el){
      var count = parseInt($(el).text().replace(/,/g, "").replace("$", ""));
      var perc = (count/total)*100;
      var group = $(el).attr("data-group");

      // create section
      var section = $("<div class='graphsection'></div>").css({
        width:perc + "%"
      }).addClass(colors[i]);

      // add classs for group
      if(group !== undefined) {
        $(el).addClass('group' + group);
        section.addClass('group' + group);
      }

      //hover over the numbers
      $(el).hover(highlight, unhighlight);
      $(section).hover(highlight, unhighlight);

      function  highlight() {
        $(el).addClass('active');
        $(section).addClass('active');
      }

      function unhighlight() {
        $(el).removeClass('active');
        $(section).removeClass('active');
      }


      $(that).append(section);
    });



  });

  var arrowInterval =0;
  var mapcurrentyear = "2011";
  var timer;
  scrollEvent.on("middle", $(".mapscroll"), function(el,i){
    yearMarkers(2013);
  });

 scrollEvent.on("top", $(".page"), function(el,i){

   $(".navbar li").removeClass("active");;
   if($(el).attr("data-section") !== "")
     $(".navbar li."+$(el).attr("data-section")).addClass("active");

 },function(){

 });
 scrollEvent.on("bottom", $(".page"), function(el,i){

   $(".navbar li").removeClass("active");;
   if($(el).attr("data-section") !== "")
     $(".navbar li."+$(el).attr("data-section")).addClass("active");

 },function(){

 });

  $(".navbar .nav li a").on("click touchend", function(e){
    e.preventDefault();
    var section = $(e.currentTarget).parent().attr("class").split(" ")[0];
    $("body,html").animate({scrollTop: $($("div.page[data-section='"+section+"']")[0]).offset().top}, 1000);
  });

});


if (!Array.prototype.indexOf)
{
  Array.prototype.indexOf = function(elt /*, from*/)
  {
    var len = this.length >>> 0;

    var from = Number(arguments[1]) || 0;
    from = (from < 0)
         ? Math.ceil(from)
         : Math.floor(from);
    if (from < 0)
      from += len;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}
